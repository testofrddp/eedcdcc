name: RDP Server Deployment (Production)

on:
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run even if another instance is running'
        required: false
        default: 'false'

jobs:
  deploy-rdp:
    runs-on: windows-latest
    timeout-minutes: 90
    permissions:
      contents: write  # Required to push connection details back to repository

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: System Information and Prerequisites
      run: |
        echo "=== SYSTEM INFORMATION ==="
        echo "OS: $env:OS"
        echo "Processor: $env:PROCESSOR_ARCHITECTURE"
        echo "User: $env:USERNAME"
        echo "PowerShell Version: $($PSVersionTable.PSVersion)"
        echo "Current Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"
        echo "=============================="

        # Check SSH availability
        try {
          $sshVersion = ssh -V 2>&1
          echo "SSH Version: $sshVersion"
        } catch {
          echo "WARNING: SSH not found, attempting to install OpenSSH..."
          try {
            Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0
            echo "âœ“ OpenSSH Client installed"
          } catch {
            echo "âœ— Failed to install OpenSSH: $_"
            exit 1
          }
        }

    - name: Enhanced RDP Configuration
      run: |
        echo "=== RDP CONFIGURATION ==="
        echo "Configuring Windows Remote Desktop with enhanced security..."

        try {
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
          echo "âœ“ Remote Desktop enabled"

          # Configure firewall rules
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          echo "âœ“ Firewall rules configured"

          # Disable Network Level Authentication (can cause issues with tunneled connections)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 0
          echo "âœ“ Network Level Authentication disabled for better tunnel compatibility"

          # Set security layer to RDP Security Layer
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "SecurityLayer" -Value 0
          echo "âœ“ Security layer set to RDP"

          # Set encryption level to low for better compatibility
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "MinEncryptionLevel" -Value 1
          echo "âœ“ Encryption level set for compatibility"

          # Configure user account
          $username = "runneradmin"
          $password = "P@ssw0rd!"
          Set-LocalUser -Name $username -Password (ConvertTo-SecureString -AsPlainText $password -Force)
          echo "âœ“ User credentials configured"

          # Restart RDP service to apply configuration changes
          echo "Restarting RDP service to apply configuration..."
          Restart-Service -Name "TermService" -Force
          Start-Sleep -Seconds 3

          # Verify RDP service
          $rdpService = Get-Service -Name "TermService"
          if ($rdpService.Status -eq "Running") {
            echo "âœ“ RDP service restarted and running"
          } else {
            echo "âš  RDP service not running, attempting to start..."
            Start-Service -Name "TermService"
            Start-Sleep -Seconds 2
            $rdpService = Get-Service -Name "TermService"
            if ($rdpService.Status -eq "Running") {
              echo "âœ“ RDP service started successfully"
            } else {
              echo "âœ— Failed to start RDP service"
            }
          }

          # Check if RDP port is listening
          Start-Sleep -Seconds 2  # Give service time to bind to port
          $rdpPort = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue
          if ($rdpPort) {
            echo "âœ“ RDP port 3389 is listening"
            echo "  Listening on: $($rdpPort.LocalAddress):$($rdpPort.LocalPort)"
          } else {
            echo "âš  RDP port 3389 not detected"
            echo "Checking all listening ports..."
            Get-NetTCPConnection -State Listen | Where-Object {$_.LocalPort -eq 3389} | ForEach-Object {
              echo "  Found RDP port: $($_.LocalAddress):$($_.LocalPort)"
            }
          }

          # Additional diagnostics
          echo "=== RDP DIAGNOSTICS ==="
          echo "Current RDP configuration:"
          $rdpConfig = Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp'
          echo "  UserAuthentication: $($rdpConfig.UserAuthentication)"
          echo "  SecurityLayer: $($rdpConfig.SecurityLayer)"
          echo "  MinEncryptionLevel: $($rdpConfig.MinEncryptionLevel)"

          $tsConfig = Get-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server'
          echo "  fDenyTSConnections: $($tsConfig.fDenyTSConnections)"

          echo "=== RDP CONFIGURATION COMPLETE ==="

        } catch {
          echo "âœ— RDP configuration failed: $_"
          echo "This may cause connection issues"
        }

    - name: Create Serveo Tunnel
      run: |
        echo "=== SERVEO TUNNEL SETUP ==="
        echo "Starting Serveo tunnel for RDP access..."
        echo "Subdomain: auto-generated"

        try {
          # Try enhanced tunnel creator first
          Write-Host "Trying enhanced tunnel creator..." -ForegroundColor Yellow
          $result = .\enhanced-tunnel-creator.ps1 -Provider "serveo"  -TimeoutSeconds 60 -MaxRetries 2 -Debug

          if ($LASTEXITCODE -eq 0) {
            Write-Host "ðŸŽ‰ SERVEO TUNNEL ACTIVE!" -ForegroundColor Green

            # Check if connection details file exists
            if (Test-Path "connection-details.json") {
              $connectionDetails = Get-Content "connection-details.json" | ConvertFrom-Json
              Write-Host "Tunnel URL: $($connectionDetails.tunnelUrl)" -ForegroundColor Cyan
              Write-Host "Username: $($connectionDetails.username)" -ForegroundColor Cyan
              Write-Host "Password: $($connectionDetails.password)" -ForegroundColor Cyan
            } else {
              Write-Host "âœ“ Tunnel established successfully" -ForegroundColor Green
            }
          } else {
            throw "Enhanced tunnel creator failed with exit code $LASTEXITCODE"
          }

        } catch {
          Write-Host "âœ— Enhanced tunnel creator failed: $_" -ForegroundColor Red
          Write-Host "Trying PuTTY tunnel creator as fallback..." -ForegroundColor Yellow

          try {
            $puttyResult = .putty-tunnel-creator.ps1 -Provider "serveo"  -TimeoutSeconds 60 -MaxRetries 2 -Debug

            if ($LASTEXITCODE -eq 0) {
              Write-Host "ðŸŽ‰ SERVEO TUNNEL ACTIVE (PuTTY)!" -ForegroundColor Green

              if (Test-Path "connection-details.json") {
                $connectionDetails = Get-Content "connection-details.json" | ConvertFrom-Json
                Write-Host "Tunnel URL: $($connectionDetails.tunnelUrl)" -ForegroundColor Cyan
                Write-Host "Username: $($connectionDetails.username)" -ForegroundColor Cyan
                Write-Host "Password: $($connectionDetails.password)" -ForegroundColor Cyan
              }
            } else {
              throw "PuTTY tunnel creator also failed"
            }
          } catch {
            Write-Host "âœ— Both tunnel creators failed: $_" -ForegroundColor Red
            
          Write-Host "Attempting failover to alternative providers..." -ForegroundColor Yellow

          # Try enhanced tunnel creator with multiple providers
          $fallbackProviders = @("serveo", "pinggy-noauth")

          foreach ($provider in $fallbackProviders) {
            Write-Host "Trying $provider as fallback..." -ForegroundColor Yellow
            try {
              $result = .\enhanced-tunnel-creator.ps1 -Provider $provider -TimeoutSeconds 45 -MaxRetries 1 -Debug

              if ($LASTEXITCODE -eq 0) {
                Write-Host "âœ“ $provider fallback successful!" -ForegroundColor Green

                if (Test-Path "connection-details.json") {
                  $connectionDetails = Get-Content "connection-details.json" | ConvertFrom-Json
                  $connectionDetails.provider = "$provider-fallback"
                  $connectionDetails | ConvertTo-Json | Out-File -FilePath "connection-details.json" -Encoding UTF8

                  Write-Host "Tunnel URL: $($connectionDetails.tunnelUrl)" -ForegroundColor Cyan
                  Write-Host "Username: $($connectionDetails.username)" -ForegroundColor Cyan
                  Write-Host "Password: $($connectionDetails.password)" -ForegroundColor Cyan
                }

                exit 0
              }
            } catch {
              Write-Host "âœ— $provider enhanced fallback failed: $_" -ForegroundColor Red
            }

            # Try PuTTY fallback for this provider
            Write-Host "Trying $provider with PuTTY as fallback..." -ForegroundColor Yellow
            try {
              $puttyResult = .\putty-tunnel-creator.ps1 -Provider $provider -TimeoutSeconds 45 -MaxRetries 1 -Debug

              if ($LASTEXITCODE -eq 0) {
                Write-Host "âœ“ $provider PuTTY fallback successful!" -ForegroundColor Green

                if (Test-Path "connection-details.json") {
                  $connectionDetails = Get-Content "connection-details.json" | ConvertFrom-Json
                  $connectionDetails.provider = "$provider-putty-fallback"
                  $connectionDetails | ConvertTo-Json | Out-File -FilePath "connection-details.json" -Encoding UTF8

                  Write-Host "Tunnel URL: $($connectionDetails.tunnelUrl)" -ForegroundColor Cyan
                  Write-Host "Username: $($connectionDetails.username)" -ForegroundColor Cyan
                  Write-Host "Password: $($connectionDetails.password)" -ForegroundColor Cyan
                }

                exit 0
              }
            } catch {
              Write-Host "âœ— $provider PuTTY fallback failed: $_" -ForegroundColor Red
            }
          }

          Write-Host "âœ— All tunnel providers failed" -ForegroundColor Red
          exit 1
          }
        }
    - name: Keep RDP Server Active
      run: |
        echo "=== RDP SERVER ACTIVE ==="
        echo "RDP server is now running and accessible"
        echo "Session will remain active for the duration of this workflow"
        echo "Maximum session time: 90 minutes (GitHub Actions limit)"
        echo ""
        echo "Connection established at: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')"
        echo "Estimated session end: $(Get-Date -Date (Get-Date).AddMinutes(85) -Format 'yyyy-MM-dd HH:mm:ss UTC')"
        echo ""
        echo "Keeping session alive..."

        # Keep alive with periodic status updates
        $startTime = Get-Date
        $maxDuration = 85 * 60  # 85 minutes in seconds
        $updateInterval = 300   # 5 minutes

        while ((Get-Date) -lt $startTime.AddSeconds($maxDuration)) {
          Start-Sleep -Seconds $updateInterval
          $elapsed = [math]::Round(((Get-Date) - $startTime).TotalMinutes, 1)
          $remaining = [math]::Round(85 - $elapsed, 1)
          echo "Session active for $elapsed minutes, $remaining minutes remaining"

          # Verify RDP service is still running
          $rdpService = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
          if ($rdpService -and $rdpService.Status -eq "Running") {
            echo "âœ“ RDP service healthy"
          } else {
            echo "âš  RDP service issue detected"
          }
        }

        echo "Session time limit reached, workflow ending"